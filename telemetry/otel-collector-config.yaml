# OpenTelemetry Collector Configuration for Apex Language Server
#
# This configuration is for local development and testing.
# It receives traces via OTLP HTTP/gRPC and exports to:
# - JSON file for dashboard consumption
# - Console logging for debugging
# - Optionally Azure Monitor for production comparison
#
# Usage:
#   npm run telemetry:start

receivers:
  otlp:
    protocols:
      http:
        endpoint: 0.0.0.0:4318
        cors:
          allowed_origins: ["*"]
          allowed_headers: ["*"]
          max_age: 7200
      grpc:
        endpoint: 0.0.0.0:4317

processors:
  # Batch processor for better performance
  batch:
    timeout: 5s
    send_batch_size: 100
    send_batch_max_size: 500

  # Resource processor to add common attributes
  resource:
    attributes:
      - key: deployment.environment
        value: development
        action: upsert
      - key: service.namespace
        value: apex-language-support
        action: upsert

exporters:
  # JSON file for dashboard consumption
  # Each line is a JSON object representing a span
  file/json:
    path: /data/traces.json
    format: json
    rotation:
      max_megabytes: 100
      max_days: 7
      max_backups: 3

  # Logging for debugging
  logging:
    verbosity: detailed
    sampling_initial: 5
    sampling_thereafter: 200

  # Tempo via OTLP - Grafana Tempo for trace storage
  otlp/tempo:
    endpoint: apex-lsp-tempo:4317
    tls:
      insecure: true

  # Optional: Forward to Azure Monitor for comparison with production
  # Uncomment and set AZURE_MONITOR_CONNECTION_STRING env var to use
  # azuremonitor:
  #   connection_string: ${env:AZURE_MONITOR_CONNECTION_STRING}

extensions:
  health_check:
    endpoint: 0.0.0.0:13133

service:
  extensions: [health_check]

  pipelines:
    # Main traces pipeline - exports to file, logging, and Tempo
    traces:
      receivers: [otlp]
      processors: [batch, resource]
      exporters: [file/json, logging, otlp/tempo]

    # Uncomment to also export to Azure Monitor
    # traces/appinsights:
    #   receivers: [otlp]
    #   processors: [batch]
    #   exporters: [azuremonitor]

  telemetry:
    logs:
      level: info
    metrics:
      level: basic
