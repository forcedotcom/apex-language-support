name: Release All

on:
  push:
    branches: [main]
  workflow_dispatch:
    inputs:
      branch:
        description: 'Branch to release from'
        required: false
        default: 'main'
        type: string
      npm-packages:
        description: 'NPM packages to release'
        required: false
        default: 'none'
        type: choice
        options:
          - none
          - all
          - changed
      extensions:
        description: 'Extensions to release'
        required: false
        default: 'apex-lsp-vscode-extension'
        type: choice
        options:
          - none
          - all
          - changed
          - apex-lsp-vscode-extension
          - apex-lsp-vscode-extension-web
      registries:
        description: 'Registries to publish extensions to'
        required: false
        default: 'all'
        type: choice
        options:
          - all
          - vscode
          - openvsx
      dry-run:
        description: 'Run in dry-run mode (no actual publishing)'
        required: false
        default: true
        type: boolean

jobs:
  get-packages:
    runs-on: ubuntu-latest
    outputs:
      npm-packages: ${{ steps.packages.outputs.npm-packages }}
      extensions: ${{ steps.packages.outputs.extensions }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.inputs.branch || github.ref }}

      - name: Get package lists
        id: packages
        uses: ./.github/actions/get-packages

  release-npm:
    needs: get-packages
    if: (github.event.inputs.npm-packages != 'none' && github.event.inputs.npm-packages != '') || (github.event_name == 'push' && github.ref == 'refs/heads/main')
    uses: ./.github/workflows/release-npm.yml
    with:
      branch: ${{ github.event.inputs.branch || github.ref_name }}
      packages: ${{ github.event.inputs.npm-packages || 'changed' }}
      available-packages: ${{ needs.get-packages.outputs.npm-packages }}
      dry-run: ${{ github.event.inputs.dry-run || false }}
    secrets: inherit

  release-extensions:
    needs: get-packages
    if: (github.event.inputs.extensions != 'none' && github.event.inputs.extensions != '') || (github.event_name == 'push' && github.ref == 'refs/heads/main')
    uses: ./.github/workflows/release-extensions.yml
    with:
      branch: ${{ github.event.inputs.branch || github.ref_name }}
      extensions: ${{ github.event.inputs.extensions || 'changed' }}
      registry: ${{ github.event.inputs.registries || 'all' }}
      available-extensions: ${{ needs.get-packages.outputs.extensions }}
      dry-run: ${{ github.event.inputs.dry-run || false }}
    secrets: inherit
