name: Package

on:
  workflow_call:
    inputs:
      node-version:
        description: 'Node.js version to use'
        required: false
        default: '20.x'
        type: string
      branch:
        description: 'Branch to package from'
        required: false
        default: 'main'
        type: string
      artifact-name:
        description: 'Name for the VSIX artifacts (base name or pre-calculated: vsix-packages-{run_number}-{mode})'
        required: false
        default: 'vsix-packages'
        type: string
      dry-run:
        description: 'Run in dry-run mode'
        required: false
        default: 'false'
        type: string
      pre-release:
        description: 'Indicates if this is a pre-release version'
        required: false
        default: 'false'
        type: string
    outputs:
      artifact-name:
        description: 'The calculated artifact name'
        value: ${{ jobs.package.outputs.artifact-name }}
  workflow_dispatch:
    inputs:
      node-version:
        description: 'Node.js version to use'
        required: false
        default: '20.x'
        type: string
      branch:
        description: 'Branch to package from'
        required: false
        default: 'main'
        type: string
      dry-run:
        description: 'Run in dry-run mode'
        required: false
        default: 'false'
        type: string
      pre-release:
        description: 'Indicates if this is a pre-release version'
        required: false
        default: 'false'
        type: string

# Add explicit permissions for security
permissions:
  contents: read
  actions: read

jobs:
  package:
    name: Package
    runs-on: ubuntu-latest
    outputs:
      artifact-name: ${{ steps.calc-artifact-name.outputs.artifact-name }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v5
        with:
          ref: ${{ inputs.branch || github.head_ref || github.ref }}

      - name: Setup Node.js ${{ inputs.node-version || '20.x' }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ inputs.node-version || '20.x' }}

      - name: Install dependencies
        uses: ./.github/actions/npm-install-with-retries

      - name: Package packages
        run: |
          if [ "${{ inputs.pre-release }}" = "true" ]; then
            npm run package:packages -- -- --pre-release
          else
            npm run package:packages
          fi

      - name: Generate MD5 checksums
        id: md5-checksums
        run: |
          echo "Generating MD5 checksums for VSIX files..."
          
          # Find all VSIX files and generate MD5 checksums
          VSIX_FILES=$(find packages -name "*.vsix" -type f)
          
          if [ -z "$VSIX_FILES" ]; then
            echo "No VSIX files found to generate checksums for"
            echo "checksums_generated=false" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          # Create checksums directory structure
          CHECKSUMS_FILE="checksums.md5"
          CHECKSUMS_JSON_FILE="checksums.json"
          > "$CHECKSUMS_FILE"  # Create/clear checksums file
          > "$CHECKSUMS_JSON_FILE"  # Create/clear JSON file
          echo "[" > "$CHECKSUMS_JSON_FILE"
          
          FIRST=true
          # Generate MD5 checksums for each VSIX file
          while IFS= read -r vsix_file; do
            if [ -f "$vsix_file" ]; then
              # Generate MD5 checksum
              MD5_HASH=$(md5sum "$vsix_file" | cut -d' ' -f1)
              
              # Get relative path for display
              RELATIVE_PATH=$(echo "$vsix_file" | sed 's|^packages/||')
              
              # Get file size
              FILE_SIZE=$(stat -c%s "$vsix_file" 2>/dev/null || stat -f%z "$vsix_file" 2>/dev/null || echo "0")
              
              # Create individual .md5 file alongside VSIX file
              MD5_FILE="${vsix_file}.md5"
              echo "$MD5_HASH  $(basename "$vsix_file")" > "$MD5_FILE"
              
              # Add to combined checksums file
              echo "$MD5_HASH  $RELATIVE_PATH" >> "$CHECKSUMS_FILE"
              
              # Add to JSON file for workflow summary
              if [ "$FIRST" = true ]; then
                FIRST=false
              else
                echo "," >> "$CHECKSUMS_JSON_FILE"
              fi
              echo "  {\"file\":\"$RELATIVE_PATH\",\"md5\":\"$MD5_HASH\",\"size\":\"$FILE_SIZE\"}" >> "$CHECKSUMS_JSON_FILE"
              
              echo "Generated MD5 for: $RELATIVE_PATH"
              echo "  MD5: $MD5_HASH"
              echo "  Size: $FILE_SIZE bytes"
            fi
          done <<< "$VSIX_FILES"
          
          echo "]" >> "$CHECKSUMS_JSON_FILE"
          
          # Move combined checksums files to packages root for artifact upload
          mv "$CHECKSUMS_FILE" "packages/checksums.md5"
          mv "$CHECKSUMS_JSON_FILE" "packages/checksums.json"
          
          echo "checksums_generated=true" >> $GITHUB_OUTPUT
          echo "checksums_file=packages/checksums.json" >> $GITHUB_OUTPUT

      - name: Calculate artifact name
        id: calc-artifact-name
        uses: ./.github/actions/calculate-artifact-name
        with:
          artifact-name: ${{ inputs.artifact-name }}
          dry-run: ${{ inputs.dry-run }}

      - name: Upload VSIX artifacts
        id: upload
        uses: actions/upload-artifact@v4
        with:
          name: ${{ steps.calc-artifact-name.outputs.artifact-name }}
          path: |
            packages/**/*.vsix
            packages/**/*.vsix.md5
            packages/checksums.md5
            packages/checksums.json
          retention-days: 5

      - name: List VSIX files
        run: |
          echo "VSIX files created:"
          find packages -name "*.vsix" -exec ls -la {} \;

      - name: Add MD5 checksums to workflow summary
        if: steps.md5-checksums.outputs.checksums_generated == 'true'
        run: |
          echo "## MD5 Checksums" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "MD5 checksums for all VSIX extension files:" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Extension | MD5 Checksum | Size |" >> $GITHUB_STEP_SUMMARY
          echo "|-----------|-------------|------|" >> $GITHUB_STEP_SUMMARY
          
          # Read checksums from JSON file and format table
          CHECKSUMS_FILE="${{ steps.md5-checksums.outputs.checksums_file }}"
          
          if [ -f "$CHECKSUMS_FILE" ]; then
            # Use node to parse JSON and format table
            node -e "
              const fs = require('fs');
              const checksums = JSON.parse(fs.readFileSync('$CHECKSUMS_FILE', 'utf8'));
              checksums.forEach(item => {
                const file = item.file || 'unknown';
                const md5 = item.md5 || 'unknown';
                const size = item.size || '0';
                const sizeFormatted = size !== '0' && size !== 'unknown' ? (parseInt(size) / 1024).toFixed(2) + ' KB' : 'unknown';
                console.log(\`|\${file} |\` + md5 + \` |\${sizeFormatted}|\`);
              });
            " >> $GITHUB_STEP_SUMMARY
          else
            echo "| No checksums available | - | - |" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Note:** Individual \`.md5\` files are available alongside each VSIX file in the artifacts." >> $GITHUB_STEP_SUMMARY
          echo "A combined \`checksums.md5\` file and \`checksums.json\` file are also included in the artifacts." >> $GITHUB_STEP_SUMMARY
